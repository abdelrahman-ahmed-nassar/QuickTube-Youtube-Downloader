name: Build Executables

on:
  release:
    types: [created]
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write # Required to upload release assets

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            output_name: quicktube-linux
            artifact_name: quicktube-linux
          - os: windows-latest
            output_name: quicktube-windows.exe
            artifact_name: quicktube-windows.exe
          - os: macos-latest
            output_name: QuickTube.app
            artifact_name: quicktube-macos.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          set-safe-directory: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller yt-dlp

      - name: Download and setup ffmpeg (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          $ffmpegPath = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          Copy-Item $ffmpegPath.FullName -Destination "ffmpeg.exe"
          Remove-Item -Path "ffmpeg.zip", "ffmpeg_temp" -Recurse -Force

      - name: Download yt-dlp (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "yt-dlp.exe"

      - name: Download and setup ffmpeg (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ffmpeg
          cp $(which ffmpeg) ffmpeg
          chmod +x ffmpeg

      - name: Download yt-dlp (macOS)
        if: runner.os == 'macOS'
        run: |
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o yt-dlp
          chmod +x yt-dlp

      - name: Download and setup ffmpeg (Linux)
        if: runner.os == 'Linux'
        run: |
          wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
          tar -xf ffmpeg-release-amd64-static.tar.xz
          find . -name "ffmpeg" -type f -executable -exec cp {} ffmpeg \;
          chmod +x ffmpeg
          rm -rf ffmpeg-release-amd64-static.tar.xz ffmpeg-*-static

      - name: Download yt-dlp (Linux)
        if: runner.os == 'Linux'
        run: |
          wget https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp
          chmod +x yt-dlp

      - name: Build executable with ffmpeg (Windows)
        if: runner.os == 'Windows'
        run: |
          pyinstaller --onefile --name quicktube-windows --console --add-binary "ffmpeg.exe;." --add-binary "yt-dlp.exe;." quicktube.py

      - name: Build macOS app bundle
        if: runner.os == 'macOS'
        run: |
          pyinstaller --windowed --name QuickTube --add-binary "ffmpeg:." --add-binary "yt-dlp:." quicktube.py

      - name: Package macOS app as zip
        if: runner.os == 'macOS'
        run: |
          cd dist
          ls -la
          if [ -d "QuickTube.app" ]; then
            zip -r quicktube-macos.zip QuickTube.app
          else
            echo "QuickTube.app not found, creating zip with QuickTube executable instead"
            zip quicktube-macos.zip QuickTube
          fi
          cd ..

      - name: Build executable with ffmpeg (Linux)
        if: runner.os == 'Linux'
        run: |
          pyinstaller --onefile --name quicktube-linux --console --add-binary "ffmpeg:." --add-binary "yt-dlp:." quicktube.py

      - name: Make executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x dist/${{ matrix.output_name }}

      - name: Upload artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/quicktube-macos.zip

      - name: Upload artifact (non-macOS)
        if: runner.os != 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.output_name }}

      - name: Upload to release (macOS)
        if: github.event_name == 'release' && runner.os == 'macOS'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/quicktube-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release (non-macOS)
        if: github.event_name == 'release' && runner.os != 'macOS'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ matrix.output_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
