name: Build Executables

on:
  push:
    tags:
      - "v*" # Trigger on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: false
        default: "dev"

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"
  # Pin versions for reproducible builds
  FFMPEG_VERSION: "latest"

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Continue building other platforms if one fails
      matrix:
        include:
          - os: ubuntu-latest
            output_name: quicktube-linux
            artifact_name: quicktube-linux
          - os: windows-latest
            output_name: quicktube-windows.exe
            artifact_name: quicktube-windows.exe
          - os: macos-latest
            output_name: QuickTube.app
            artifact_name: quicktube-macos.zip
          # Add ARM64 macOS build
          - os: macos-14 # M1/M2 runner
            output_name: QuickTube.app
            artifact_name: quicktube-macos-arm64.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller yt-dlp
          pip install pillow  # For icon handling

      - name: Download and setup ffmpeg (Windows)
        if: runner.os == 'Windows'
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Downloading ffmpeg..."
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          $ffmpegPath = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          if (-not $ffmpegPath) { throw "ffmpeg.exe not found" }
          Copy-Item $ffmpegPath.FullName -Destination "ffmpeg.exe"
          # Verify ffmpeg works
          .\ffmpeg.exe -version
          Remove-Item -Path "ffmpeg.zip", "ffmpeg_temp" -Recurse -Force

      - name: Download yt-dlp (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "yt-dlp.exe"
          .\\yt-dlp.exe --version

      - name: Download and setup ffmpeg (macOS)
        if: runner.os == 'macOS'
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            # For ARM64, use static build from osxexperts
            curl -L "https://www.osxexperts.net/ffmpeg7arm.zip" -o ffmpeg.zip
            unzip -q ffmpeg.zip
            # Find and move the ffmpeg binary (handle different possible structures)
            find . -name "ffmpeg" -type f -perm +111 2>/dev/null | head -1 | xargs -I {} mv {} ffmpeg || \
            find . -name "ffmpeg" -type f -executable 2>/dev/null | head -1 | xargs -I {} mv {} ffmpeg
          else
            # For Intel, use evermeet.cx
            curl -L "https://evermeet.cx/ffmpeg/getrelease/zip" -o ffmpeg.zip
            unzip -q ffmpeg.zip
          fi
          chmod +x ffmpeg
          ./ffmpeg -version
          rm -rf ffmpeg.zip

      - name: Download yt-dlp (macOS)
        if: runner.os == 'macOS'
        run: |
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o yt-dlp
          chmod +x yt-dlp
          ./yt-dlp --version

      - name: Download and setup ffmpeg (Linux)
        if: runner.os == 'Linux'
        run: |
          # Use yt-dlp's ffmpeg builds for consistency
          wget -q https://github.com/yt-dlp/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar -xf ffmpeg-master-latest-linux64-gpl.tar.xz
          find . -name "ffmpeg" -type f -executable -exec cp {} ffmpeg \;
          chmod +x ffmpeg
          ./ffmpeg -version
          rm -rf ffmpeg-master-latest-linux64-gpl.tar.xz ffmpeg-*-linux64-gpl

      - name: Download yt-dlp (Linux)
        if: runner.os == 'Linux'
        run: |
          wget -q https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp
          chmod +x yt-dlp
          ./yt-dlp --version

      - name: Build executable with ffmpeg (Windows)
        if: runner.os == 'Windows'
        run: |
          pyinstaller --onefile --name quicktube-windows --console --add-binary "ffmpeg.exe;." --add-binary "yt-dlp.exe;." quicktube.py

      - name: Build macOS executable
        if: runner.os == 'macOS'
        run: |
          pyinstaller --onefile --name QuickTube --console --add-binary "ffmpeg:." --add-binary "yt-dlp:." quicktube.py

      - name: Create macOS app bundle
        if: runner.os == 'macOS'
        run: |
          # Get version from release tag or input
          VERSION="${GITHUB_REF_NAME:-${{ github.event.inputs.version || '1.0.0' }}}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present

          mkdir -p QuickTube.app/Contents/MacOS
          mkdir -p QuickTube.app/Contents/Resources

          # Move the executable
          mv dist/QuickTube QuickTube.app/Contents/MacOS/

          # Create launcher script that opens Terminal
          cat > QuickTube.app/Contents/MacOS/launcher.sh << 'EOF'
          #!/bin/bash
          DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          # Create output directory next to app if it doesn't exist
          APP_DIR="$(dirname "$(dirname "$(dirname "$DIR")")")" 
          mkdir -p "$APP_DIR/output" 2>/dev/null || true
          open -a Terminal "$DIR/QuickTube"
          EOF
          chmod +x QuickTube.app/Contents/MacOS/launcher.sh

          # Create Info.plist with version
          cat > QuickTube.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>launcher.sh</string>
              <key>CFBundleIdentifier</key>
              <string>com.quicktube.app</string>
              <key>CFBundleName</key>
              <string>QuickTube</string>
              <key>CFBundleDisplayName</key>
              <string>QuickTube</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.utilities</string>
          </dict>
          </plist>
          EOF

          mv QuickTube.app dist/

      - name: Package macOS app as zip
        if: runner.os == 'macOS'
        run: |
          cd dist
          zip -r quicktube-macos.zip QuickTube.app
          cd ..

      - name: Build executable with ffmpeg (Linux)
        if: runner.os == 'Linux'
        run: |
          pyinstaller --onefile --name quicktube-linux --console --add-binary "ffmpeg:." --add-binary "yt-dlp:." quicktube.py

      - name: Make executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x dist/${{ matrix.output_name }}

      - name: Test executable (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Testing executable..."
          ./dist/quicktube-linux --help 2>&1 || echo "Note: App requires terminal interaction"

      - name: Test executable (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Testing executable..."
          # Just verify the file exists and is executable
          Get-Item dist\\quicktube-windows.exe

      - name: Calculate checksums
        shell: bash
        run: |
          cd dist
          if [ "$RUNNER_OS" == "macOS" ]; then
            shasum -a 256 quicktube-macos.zip > quicktube-macos.zip.sha256
          elif [ "$RUNNER_OS" == "Windows" ]; then
            sha256sum quicktube-windows.exe > quicktube-windows.exe.sha256
          else
            sha256sum quicktube-linux > quicktube-linux.sha256
          fi
          cat *.sha256

      - name: Upload artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            dist/quicktube-macos.zip
            dist/quicktube-macos.zip.sha256

      - name: Upload artifact (non-macOS)
        if: runner.os != 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            dist/${{ matrix.output_name }}
            dist/${{ matrix.output_name }}.sha256

      - name: Upload to release (macOS)
        if: startsWith(github.ref, 'refs/tags/') && runner.os == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/quicktube-macos.zip
            dist/quicktube-macos.zip.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release (non-macOS)
        if: startsWith(github.ref, 'refs/tags/') && runner.os != 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/${{ matrix.output_name }}
            dist/${{ matrix.output_name }}.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
