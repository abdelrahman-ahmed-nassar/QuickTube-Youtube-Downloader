name: Build Executables

on:
  release:
    types: [created]
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            output_name: yt-downloader-linux
            artifact_name: yt-downloader-linux
          - os: windows-latest
            output_name: yt-downloader-windows.exe
            artifact_name: yt-downloader-windows.exe
          - os: macos-latest
            output_name: yt-downloader-macos
            artifact_name: yt-downloader-macos

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller yt-dlp

      - name: Download and setup ffmpeg (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          $ffmpegPath = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          Copy-Item $ffmpegPath.FullName -Destination "ffmpeg.exe"
          Remove-Item -Path "ffmpeg.zip", "ffmpeg_temp" -Recurse -Force

      - name: Download and setup ffmpeg (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ffmpeg
          cp $(which ffmpeg) ffmpeg
          chmod +x ffmpeg

      - name: Download and setup ffmpeg (Linux)
        if: runner.os == 'Linux'
        run: |
          wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
          tar -xf ffmpeg-release-amd64-static.tar.xz
          find . -name "ffmpeg" -type f -executable -exec cp {} ffmpeg \;
          chmod +x ffmpeg
          rm -rf ffmpeg-release-amd64-static.tar.xz ffmpeg-*-static

      - name: Build executable with ffmpeg (Windows)
        if: runner.os == 'Windows'
        run: |
          pyinstaller --onefile --name yt-downloader-windows --console --add-binary "ffmpeg.exe;." yt-downloader.py

      - name: Build executable with ffmpeg (Unix)
        if: runner.os != 'Windows'
        run: |
          pyinstaller --onefile --name ${{ matrix.output_name }} --console --add-binary "ffmpeg:." yt-downloader.py

      - name: Make executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x dist/${{ matrix.output_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.output_name }}

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ matrix.output_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
